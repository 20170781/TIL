## 10 - 전송 프로토콜

### 1) 전송 프로토콜과 UDP

#### 프로세스 간의 통신

- **데이터링크 계층**은 이웃한 **노드 사이**의 프레임 전달에 관여 (**MAC 주소**)
  **네트워크 계층**은 **호스트 사이**의 패킷 전달에 관여 (**IP 주소**)
  **수송 계층**은 **프로세스 사이**의 메시지 전달에 관여 (**포트 번호**)

  <img src="https://user-images.githubusercontent.com/70627979/150261784-cd726dbc-fc3b-44f2-80a8-d9cb74f9d92f.png" alt="image" style="zoom: 50%;" />

  (호스트 안에서 실행 중인 프로그램을 프로세스라고 함)

  즉, 호스트 컴퓨터까지 오는 것은 네트워크 계층이 관리를 해주지만, 컴퓨터 내에 있는 브라우저로 보낼지 파일 다운로드하는 프로그램으로 보낼지에 대한 컨트롤이 전송 계층에서 이루어진다.

  

- 클라이언트/서버

  - 구성
    - 프로세스간의 통신은 **클라이언트/서버** 구성을 통해서 이루어짐
      서버 프로세스가 어떤 클라이언트 프로세스에게 데이터를 전송해야할지 구분이 필요 -> **포트번호** 사용(물리x, **논리o**)
    - **포트 번호**는 **수송 계층에서 사용하는 주소**로, 특정 호스트에서 실행되는 **프로세스를 구분**하기 위해 사용
      (포트 번호는 16비트 정수로, **0에서 65535 사이의 값**을 가짐)

  - 구분
    - **클라이언트 프로그램**은 포트 번호를 갖게 되는데, **운영체제**에 의해서 선택된다.
      이러한 포트는 일시적으로 할당되고 사라져 **임시 포트 번호(ephemeral port number)**라고 함
    - **서버 프로그램**은 인터넷에서 식별을 위해 **동일한 포트 번호**를 갖는다.
      이러한 포트는 고정적으로 할당되고 모두 알고 있어야 하기 때문에 **알려진 포트 번호(well-known port numbers)**라고 함

<img src="https://user-images.githubusercontent.com/70627979/150263626-c005fd95-71a5-4e3c-81cb-d1b11cb48050.png" alt="image" style="zoom:50%;" />

- **포트 번호** (논리적인 포트)
  - IANA (Internet Assigned Numbers Authority)에서 포트번호 관리
  - 구분
    - **Well-known ports**: 인터넷 서비스를 위해 사용 (0~1023)
    - **Registered ports:** 특정 응용을 위해 기관 및 기업이 사용 (1024~49151)
    - **Dynamic ports**: 임시 포트(ephemeral ports)로 사용, 등록 및 통제x (49152~65535)



#### UDP (User Datagram protocol)

- UDP는 **비연결형, 비신뢰성** 수송 프로토콜

  - 흐름 및 에러제어 x
  - UDP가 에러 검출 시 단순 폐기
  - **연결 설정이나 종료 과정이 없음**
  - 데이터그램들 사이의 **서로 관련이 없으며, 번호가 붙지 않음**
  - 각 UDP 데이터그램은 서로 **다른 경로로 전달**
    - **수신자**는 수신 메시지로 **오버 플로우**될 수 있음
    - **송신자**는 **메시지가 유실되거나 중복되었는지 알 수 없음**

- UDP는 **오버헤드가 작은** 아주 단순한 프로토콜에 사용

- Well-known ports used with UDP

  : 인터넷에서 응용에 해당되는 프로토콜들은 포트번호가 할당되어 있다.

  - DNS(Domain Name Service): UDP 포트번호 53
  - SNMP(Simple Network Management Protocol): UDP 포트번호 161, 162

- User datagram

  - UDP는 8바이트의 고정된 크기의 헤더를 갖음(다른 헤더들에 비해 작음)

  - 체크섬은 옵션 (오류 검출 목적)

    <img src="https://user-images.githubusercontent.com/70627979/150266204-c2ad8b93-7eee-4307-bec4-68dc930b0163.png" alt="image" style="zoom:50%;" />

- Checksum
  - UDP 체크섬 계산은 IP나 ICMP와 달리 **가상헤더**를 만들어 계산 
    (**가상헤더, UDP헤더, 데이터에 대해서 체크섬을 수행**)
  - 가상헤더는 IP패킷의 헤더에서 가져온 정보로 구성
    - **송신자 IP주소, 목적지 IP주소, 프로토콜 필드, 전체 길이 필드** 구성
    - IP헤더가 잘못되면 잘못된 호스트나 잘못된 수송계층 프로토콜로 전달되므로 한번 더 검사

- **UDP의 사용**
  - UDP는 **간단한 요청 및 응답** 서비스에 적합 (연결설정/해제 과정의 오버헤드가 없음)
  - **프로세스에서 내부 흐름제어와 에러제어를 갖는 경우 적합**
    (**응용 프로그램이 자체적**으로 갖고 있는 기능을 중복해서 가질 필요가 없음)
  - **멀티캐스팅**에 적합 (그룹에 속한 모든 시스템과 연결 설정할 필요 없음)
  - **SNMP**와 같은 관리시스템, **RIP** 라우팅 프로토콜에서 사용



### 2) TCP 프로토콜

#### TCP의 기능

- TCP는 **프로세스간 통신**, **스트림 전달 서비스**, **전이중 통신**(보내기, 받기 동시에), **연결 지향 서비스**(연결 먼저), **신뢰성 있는 서비스** 제공
  - **연결설정과 해제과정**이 존재
  - ACK를 사용해 신뢰성 있는 전송 제공
- TCP는 프로세스 간의 통신을 위해 **포트 번호를 사용**
- 스트림 전달 서비스: 데이터를 바이트의 나열로 전달
  - 효율성을 위해 여러 바이트를 블록으로 구성된 세그먼트를 만들어 전송
- Well-known ports used by TCP
  - DNS: TCP 포트번호 53
  - FTP(File Transfer Protocol): TCP 포트번호 20, 21
  - SMTP(Simple Mail Transfer Protocol): TCP 포트번호 25

- TCP 특징
  - **TCP는 모든 바이트에 번호를 부여**
    - 번호는 **흐름제어와 에러제어**에 사용
    - **세그먼트의 순서번호**는 해당 세그먼트가 나르는 데이터의 **첫 번째 바이트 번호**
  - ACK 번호는 수신해야 할 다음 바이트 번호
    - ACK 번호는 누적 값으로, 이전의 모든 바이트를 안전하게 받았음을 의미



#### 세그먼트 형태

<img src="https://user-images.githubusercontent.com/70627979/150277045-f4eb6c25-6fae-4700-acaa-c5f815a7ae78.png" alt="image" style="zoom:67%;" />

- 헤더는 20바이트 (옵션이 있다면 60바이트까지 존재)

  - 4바이트 단위로 표시

- **제어 필드**

  : 현재 세그먼트가 어떤 세그먼트인지 나타내기 위한 필드

  <img src="https://user-images.githubusercontent.com/70627979/150277565-f8aeca2b-99df-491f-9b63-1e2f9fc14958.png" alt="image" style="zoom:50%;" />

- 긴급 데이터

  - 송신자는 수신자가 순서에 관계없이 우선적으로 데이터가 처리되길 원할 수 있음
  - URG 비트가 1로 세팅되면, Urgent pointer라는 숫자가 들어가 Urgent 데이터가 어디까지인지 가리킴

- 송신 TCP는 수신 TCP가 버퍼링을 하지 않고 즉시 데이터를 응용에게 전달할 것을 요구

  - 제어 필드의 PSH 비트를 설정

- RST은 비정상적인 상황 혹은 오랫동안 통신이 없으면 현재의 연결을 끊음

- 체크섬
  - **데이터에 대한 오류를 검사**하여 재전송에 의한 복구를 수행
  - TCP에서 체크섬은 **강제사항**이며, UDP에서와 같은 **가상헤더를 포함**하여 계산



#### 연결 설정과 해제

- TCP는 **3단계 메시지 교환(Three-way handshake)**을 통해 **연결 설정**

  1. 클라이언트는 연결을 요청하는 **SYN** 세그먼트 전송
  2. 서버는 **SYN**과 **ACK**를 포함하는 세그먼트로 응답
  3. 클라이언트가 **ACK** 세그먼트 전송

  <img src="https://user-images.githubusercontent.com/70627979/150278605-4b15448b-4b83-4652-9cda-80402ac81401.png" alt="image" style="zoom:50%;" />

- TCP는 **연결 해제**를 위해 **3단계(three-way handshaking)** 와 **4단계(four-way handshaking)** 메시지 교환을 제공

  - **3단계 메시지 교환**을 통한 연결 해제는 **즉시 연결을 종료**

  - **4단계 메시지 교환**을 통한 연결 해제는 **half-close 상태**를 만들어 **수신은 가능**하게 함 (서버에서 보낼게 남아있을 때)

    

  1. 클라이언트가 **FIN** 세그먼트 전송
  2. 서버가 **FIN**과 **ACK**를 포함하는 세그먼트로 응답 
     (4단계면 **ACK** 먼저 전송, 그리고 데이터 세그먼트 전송 후 **FIN** 세그먼트 전송)
  3. 클라이언트가 **ACK** 세그먼트 전송



#### 흐름 제어

- 통신 TCP가 목적지로부터 **ACK를 수신하기 전에 보낼 수 있는 데이터의 양**을 정함

  - **TCP는 슬라이딩 윈도우 프로토콜을(sliding window protocol)** 이용
  - TCP는 바이트 단위로 **윈도우 크기(수신 가능한 데이터 양)**를 명시
  - 윈도우 크기는 **시간에 따라서 변할 수 있음**

  
